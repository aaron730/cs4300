{% extends 'bookings/base.html' %}

{% block content %}
<div class="py-4 d-flex flex-column align-items-center">
    <h2 class="mb-2">Book a Seat for <em>{{ movie.title }}</em></h2>
    <p class="lead text-center">Click an available (blue) seat to book it. Booked seats are red.</p>

    <div class="w-100 d-flex justify-content-center mt-4">
        <div style="overflow-x:auto;">
            <!-- Use Bootstrap grid with 10 columns per row. Each seat is a small button. -->
            <div id="seat-map" class="d-flex flex-column align-items-center">
                {% comment %} Render seats in rows of 10 {% endcomment %}
                {% for seat in seats %}
                    {% if forloop.first or forloop.counter0|divisibleby:10 %}
                        <div class="d-flex justify-content-center mb-2">
                    {% endif %}

                    <button type="button"
                            class="btn btn-seat me-2 {% if seat.is_booked %}btn-danger disabled{% else %}btn-primary{% endif %}"
                            data-seat-id="{{ seat.id }}"
                            data-seat-number="{{ seat.seat_number }}"
                            aria-pressed="false">
                        {{ seat.seat_number }}
                    </button>

                    {% if forloop.counter|divisibleby:10 or forloop.last %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="mt-3">
        <span class="me-3"><span class="badge bg-primary">&nbsp;&nbsp;</span> Available</span>
        <span><span class="badge bg-danger">&nbsp;&nbsp;</span> Booked</span>
    </div>
</div>

<!-- Hidden form used to submit booking POST when user confirms in the modal -->
<form id="booking-form" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="seat" id="selected-seat-input" value="">
</form>

<!-- Confirmation modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Do you want to book seat <strong id="modal-seat-number"></strong> for <em>{{ movie.title }}</em>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-book-btn" class="btn btn-primary">Yes, Book Seat</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Small helper to make buttons square and consistent */
.btn-seat { width:56px; height:56px; padding:0; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; font-weight:600; }
.btn-seat:focus { box-shadow:0 0 0 0.25rem rgba(13,110,253,0.25); }
.btn-seat.disabled { opacity:0.95; }
.btn-seat:hover:not(.disabled) { transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.12); }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const seatMap = document.getElementById('seat-map');
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    let selectedSeatId = null;

    seatMap.addEventListener('click', function(e){
        const el = e.target.closest('.btn-seat');
        if(!el) return;
        if(el.classList.contains('disabled')) return; // ignore clicks on booked seats

        selectedSeatId = el.dataset.seatId;
        const seatNumber = el.dataset.seatNumber;
        document.getElementById('modal-seat-number').textContent = seatNumber;
        modal.show();
    });

    document.getElementById('confirm-book-btn').addEventListener('click', function(){
        if(!selectedSeatId) return;
        document.getElementById('selected-seat-input').value = selectedSeatId;
        document.getElementById('booking-form').submit();
    });
});
</script>

{% endblock %}
